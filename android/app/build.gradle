// =============================================================================
// APK Build - android/app/build.gradle (app module)
// Node runs from PROJECT_ROOT (parent of android/) so node_modules is found.
// =============================================================================

apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

// Repo root (parent of android/)
def projectRootDir = rootDir.parentFile
def projectRootPath = projectRootDir.absolutePath

static def versionToNumber(major, minor, patch) {
  return patch * 100 + minor * 10000 + major * 1000000
}

def nodeRun(String script) {
  def proc = ["node", "-e", script].execute(null, projectRootDir)
  proc.waitFor()
  if (proc.exitValue() != 0) throw new GradleException("node failed: " + proc.err.text)
  return proc.text.trim()
}

def getRNVersion() {
  def v = nodeRun("console.log(require('react-native/package.json').version)")
  def parts = v.split("-")[0].tokenize(".").collect { it.toInteger() }
  return versionToNumber(parts[0], parts[1], parts[2])
}
def rnVersion = getRNVersion()

react {
  def entryProc = ["node", "-e", "console.log(require('expo/scripts/resolveAppEntry')(process.argv[1], process.argv[2], process.argv[3]))", projectRootPath, "android", "absolute"].execute(null, projectRootDir)
  entryProc.waitFor()
  entryFile = file(entryProc.text.trim())
  reactNativeDir = new File(nodeRun("console.log(require.resolve('react-native/package.json'))")).parentFile.absoluteFile
  hermesCommand = new File(nodeRun("console.log(require.resolve('react-native/package.json'))")).parentFile.absolutePath + "/sdks/hermesc/%OS-BIN%/hermesc"
  codegenDir = new File(nodeRun("console.log(require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] }))")).parentFile.absoluteFile
  cliFile = new File(nodeRun("console.log(require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] }))"))
  bundleCommand = "export:embed"
  if (rnVersion >= versionToNumber(0, 75, 0)) {
    autolinkLibrariesWithApp()
  }
}

def enableProguardInReleaseBuilds = (findProperty("android.enableProguardInReleaseBuilds") ?: false).toBoolean()
def jscFlavor = "org.webkit:android-jsc:+"

android {
  ndkVersion rootProject.ext.ndkVersion
  buildToolsVersion rootProject.ext.buildToolsVersion
  compileSdk rootProject.ext.compileSdkVersion

  namespace "com.krishna3163.gphoton"
  defaultConfig {
    applicationId "com.krishna3163.gphoton"
    minSdkVersion rootProject.ext.minSdkVersion
    targetSdkVersion rootProject.ext.targetSdkVersion
    versionCode 1
    versionName "1.0.0"
  }

  signingConfigs {
    debug {
      storeFile file("debug.keystore")
      storePassword "android"
      keyAlias "androiddebugkey"
      keyPassword "android"
    }
    release {
      storeFile file("release.keystore")
      storePassword "gphoto2024"
      keyAlias "gphoto_key"
      keyPassword "gphoto2024"
    }
  }

  buildTypes {
    debug {
      signingConfig signingConfigs.debug
    }
    release {
      signingConfig signingConfigs.release
      shrinkResources (findProperty("android.enableShrinkResourcesInReleaseBuilds")?.toBoolean() ?: false)
      minifyEnabled enableProguardInReleaseBuilds
      proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
      crunchPngs (findProperty("android.enablePngCrunchInReleaseBuilds")?.toBoolean() ?: true)
    }
  }

  packagingOptions {
    jniLibs {
      useLegacyPackaging (findProperty("expo.useLegacyPackaging")?.toBoolean() ?: false)
    }
  }
}

["pickFirsts", "excludes", "merges", "doNotStrip"].each { prop ->
  def options = (findProperty("android.packagingOptions.${prop}") ?: "").split(",")
  options = options.collect { it.trim() } - ""
  if (options.length > 0) {
    options.each { android.packagingOptions[prop] += it }
  }
}

dependencies {
  implementation("com.facebook.react:react-android")
  def isGifEnabled = (findProperty("expo.gif.enabled") ?: "") == "true"
  def isWebpEnabled = (findProperty("expo.webp.enabled") ?: "") == "true"
  def isWebpAnimatedEnabled = (findProperty("expo.webp.animated") ?: "") == "true"
  if (isGifEnabled) {
    implementation("com.facebook.fresco:animated-gif:${reactAndroidLibs.versions.fresco.get()}")
  }
  if (isWebpEnabled) {
    implementation("com.facebook.fresco:webpsupport:${reactAndroidLibs.versions.fresco.get()}")
    if (isWebpAnimatedEnabled) {
      implementation("com.facebook.fresco:animated-webp:${reactAndroidLibs.versions.fresco.get()}")
    }
  }
  if (hermesEnabled.toBoolean()) {
    implementation("com.facebook.react:hermes-android")
  } else {
    implementation jscFlavor
  }
}

if (rnVersion < versionToNumber(0, 75, 0)) {
  apply from: new File(nodeRun("console.log(require.resolve('@react-native-community/cli-platform-android/package.json', { paths: [require.resolve('react-native/package.json')] }))"), "../native_modules.gradle")
  applyNativeModulesAppBuildGradle(project)
}
