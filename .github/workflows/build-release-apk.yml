name: Build Release APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Verify npm dependencies
        run: npm ls --depth=0

      - name: ðŸ”§ Apply native patches
        run: |
          if [ -f scripts/fix-text-recognition.js ]; then
            node scripts/fix-text-recognition.js
          else
            echo "No patch script, skipping."
          fi

      - name: ðŸ”‘ Setup Release Keystore from GitHub Secrets
        id: keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
            echo "âœ… Keystore imported from GitHub Secrets"
            ls -lh android/app/release.keystore
            echo "has_keystore=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  RELEASE_KEYSTORE_BASE64 not set â€” building unsigned release. Add the secret for signed builds."
            echo "has_keystore=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”§ Use debug signing when keystore missing
        if: steps.keystore.outputs.has_keystore != 'true'
        run: |
          sed -i.bak 's/signingConfig signingConfigs.release/signingConfig signingConfigs.debug/' android/app/build.gradle
          echo "Release build will use debug signing (unsigned)."

      - name: ðŸ”‘ Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: ðŸ”¨ Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease \
            -Dorg.gradle.jvmargs="-Xmx2048m" \
            --stacktrace --info
          ls -lh app/build/outputs/apk/release/

      - name: ðŸ“¤ Upload Release APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TelePhoto-Cloud-Release-APK
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      - name: ðŸ“¤ Upload Debug APK (Fallback on build failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: TelePhoto-Cloud-Debug-APK
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      - name: ðŸ“ Generate Build Report
        if: always()
        run: |
          echo "# TelePhoto Cloud Build Report" > build_report.md
          echo "" >> build_report.md
          echo "## Build Information" >> build_report.md
          echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build_report.md
          echo "- **Commit**: $(git rev-parse --short HEAD)" >> build_report.md
          echo "- **Author**: $(git log -1 --pretty=format:'%an')" >> build_report.md
          echo "- **Branch**: main" >> build_report.md
          echo "" >> build_report.md
          echo "## App Details" >> build_report.md
          echo "- **Name**: TelePhoto Cloud" >> build_report.md
          echo "- **Package**: com.krishna3163.gphoton" >> build_report.md
          echo "- **Version**: 1.0.0" >> build_report.md
          echo "- **Build Type**: Release (Signed)" >> build_report.md
          echo "- **Min SDK**: API 23 (Android 6.0)" >> build_report.md
          echo "- **Target SDK**: API 34 (Android 14)" >> build_report.md
          echo "" >> build_report.md
          echo "## Features" >> build_report.md
          echo "âœ… Opening animation (3 random videos)" >> build_report.md
          echo "âœ… Permission-based onboarding" >> build_report.md
          echo "âœ… Photo gallery with sync" >> build_report.md
          echo "âœ… Cloud backup via Telegram" >> build_report.md
          echo "âœ… File viewer and search" >> build_report.md
          echo "âœ… Dark mode support" >> build_report.md
          echo "âœ… Background sync" >> build_report.md
          echo "" >> build_report.md
          if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
            echo "## âœ… Build Status: SUCCESS" >> build_report.md
            echo "" >> build_report.md
            echo "### APK Details" >> build_report.md
            SIZE=$(ls -lh android/app/build/outputs/apk/release/app-release.apk | awk '{print $5}')
            echo "- **File Size**: $SIZE" >> build_report.md
            echo "- **Signature**: Release (Signed)" >> build_report.md
            echo "- **Ready for**: Google Play Store" >> build_report.md
          else
            echo "## âŒ Build Status: FAILED" >> build_report.md
            echo "- APK not found at expected location" >> build_report.md
          fi
          echo "" >> build_report.md
          cat build_report.md

      - name: ðŸ“Š Commit Build Report
        if: always()
        run: |
          if [ ! -z "$(git status --porcelain)" ]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add build_report.md || true
            git commit -m "Build report: $(date +%Y-%m-%d)" || true
            git push || true
          fi
