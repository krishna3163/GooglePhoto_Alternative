name: Build Release APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ‚òï Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: ‚úÖ Verify npm dependencies
        run: npm ls --depth=0

      - name: üîß Apply native patches
        run: node scripts/fix-text-recognition.js

      - name: üîë Setup Release Keystore from GitHub Secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
            echo "‚úÖ Keystore imported from GitHub Secrets"
            ls -lh android/app/release.keystore
          else
            echo "‚ö†Ô∏è  WARNING: RELEASE_KEYSTORE_BASE64 secret not found"
            echo "Please add the release keystore to GitHub Secrets:"
            echo "1. Encode: base64 -w 0 < android/app/release.keystore"
            echo "2. Add as secret: RELEASE_KEYSTORE_BASE64"
            exit 1
          fi

      - name: üîë Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: üî® Build Release APK (Signed)
        run: |
          cd android
          ./gradlew assembleRelease \
            -Dorg.gradle.jvmargs="-Xmx2048m" \
            --stacktrace --info
          ls -lh app/build/outputs/apk/release/

      - name: üì§ Upload Release APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TelePhoto-Cloud-Release-APK
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      - name: üì§ Upload Unsigned APK (Fallback)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: TelePhoto-Cloud-Unsigned-APK
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      - name: üìù Generate Build Report
        if: always()
        run: |
          echo "# TelePhoto Cloud Build Report" > build_report.md
          echo "" >> build_report.md
          echo "## Build Information" >> build_report.md
          echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build_report.md
          echo "- **Commit**: $(git rev-parse --short HEAD)" >> build_report.md
          echo "- **Author**: $(git log -1 --pretty=format:'%an')" >> build_report.md
          echo "- **Branch**: main" >> build_report.md
          echo "" >> build_report.md
          echo "## App Details" >> build_report.md
          echo "- **Name**: TelePhoto Cloud" >> build_report.md
          echo "- **Package**: com.krishna3163.gphoton" >> build_report.md
          echo "- **Version**: 1.0.0" >> build_report.md
          echo "- **Build Type**: Release (Signed)" >> build_report.md
          echo "- **Min SDK**: API 23 (Android 6.0)" >> build_report.md
          echo "- **Target SDK**: API 34 (Android 14)" >> build_report.md
          echo "" >> build_report.md
          echo "## Features" >> build_report.md
          echo "‚úÖ Opening animation (3 random videos)" >> build_report.md
          echo "‚úÖ Permission-based onboarding" >> build_report.md
          echo "‚úÖ Photo gallery with sync" >> build_report.md
          echo "‚úÖ Cloud backup via Telegram" >> build_report.md
          echo "‚úÖ File viewer and search" >> build_report.md
          echo "‚úÖ Dark mode support" >> build_report.md
          echo "‚úÖ Background sync" >> build_report.md
          echo "" >> build_report.md
          if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
            echo "## ‚úÖ Build Status: SUCCESS" >> build_report.md
            echo "" >> build_report.md
            echo "### APK Details" >> build_report.md
            SIZE=$(ls -lh android/app/build/outputs/apk/release/app-release.apk | awk '{print $5}')
            echo "- **File Size**: $SIZE" >> build_report.md
            echo "- **Signature**: Release (Signed)" >> build_report.md
            echo "- **Ready for**: Google Play Store" >> build_report.md
          else
            echo "## ‚ùå Build Status: FAILED" >> build_report.md
            echo "- APK not found at expected location" >> build_report.md
          fi
          echo "" >> build_report.md
          cat build_report.md

      - name: üìä Commit Build Report
        if: always()
        run: |
          if [ ! -z "$(git status --porcelain)" ]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add build_report.md || true
            git commit -m "Build report: $(date +%Y-%m-%d)" || true
            git push || true
          fi
